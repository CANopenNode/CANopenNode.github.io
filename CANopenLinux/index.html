<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CANopenLinux: CANopenLinux</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="CANopenNode.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CANopenLinux
   </div>
   <div id="projectbrief">CANopenNode on Linux devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">CANopenLinux </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="readmeCANopenLinux"></a></p>
<p>CANopenLinux is a CANopen stack running on Linux devices.</p>
<p>It is based on <a href="https://github.com/CANopenNode/CANopenNode">CANopenNode</a>, which is free and open source CANopen Stack and is included as a git submodule.</p>
<p>CANopen is the internationally standardized (EN 50325-4) (<a href="http://can-cia.org/standardization/technical-documents">CiA301</a>) CAN-based higher-layer protocol for embedded control system. For more information on CANopen see <a href="http://www.can-cia.org/">http://www.can-cia.org/</a>.</p>
<p>CANopenLinux homepage is <a href="https://github.com/CANopenNode/CANopenLinux">https://github.com/CANopenNode/CANopenLinux</a></p>
<h1><a class="anchor" id="autotoc_md0"></a>
Getting or updating the project</h1>
<p>Clone the project from git repository and get submodules: </p><pre class="fragment">git clone https://github.com/CANopenNode/CANopenLinux.git
cd CANopenLinux
git submodule init
git submodule update
</pre><p> Update the project: </p><pre class="fragment">cd CANopenLinux
git pull # or: git fetch; inspect the changes (gitk); git merge
git submodule update
</pre><h1><a class="anchor" id="autotoc_md1"></a>
Usage</h1>
<p>Support for CAN interface is part of the Linux kernel, so called <a href="https://en.wikipedia.org/wiki/SocketCAN">SocketCAN</a>. CANopenNode runs on top of SocketCAN, so it should be able to run on any Linux machine, it depends on configuration of the kernel. Examples below was tested on Debian based machines, including Ubuntu and Raspberry PI. It is possible to run tests described below without real CAN interface, because Linux kernel already contains virtual CAN interface.</p>
<p>Windows or Mac users, who don't have Linux installed, can use <a href="https://www.virtualbox.org/">VirtualBox</a> and install <a href="https://ubuntu.com/download/desktop">Ubuntu</a> or similar. To get confortable you may like to enroll <a href="https://training.linuxfoundation.org/training/introduction-to-linux/">Introduction to Linux</a>.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
CAN interfaces</h2>
<h3><a class="anchor" id="autotoc_md3"></a>
Virtual CAN interface</h3>
<p>It can connect multiple programs inside Linux machine. It can be activated by the following commands: </p><pre class="fragment">sudo modprobe vcan
sudo ip link add dev can0 type vcan
sudo ip link set up can0
</pre> <h3><a class="anchor" id="autotoc_md4"></a>
USB, PCI or similar CAN interface</h3>
<p>There are several CAN interfaces on the market which works with Linux SocketCAN. See <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/can">Linux kernel source</a>, Kconfig files, for supported interfaces by the Linux kernel. For example <a href="https://www.ems-wuensche.com/?post_type=product&amp;p=746">EMS CPC-USB</a> or <a href="http://www.peak-system.com/PCAN-USB-FD.365.0.html?&amp;L=1">PCAN-USB FD</a>. Usually such interface is started with: </p><pre class="fragment">sudo ip link set up can0 type can bitrate 250000
</pre> <h3><a class="anchor" id="autotoc_md5"></a>
Serial slcan interface</h3>
<p>Most cheap CAN interface, for example <a href="http://www.fischl.de/usbtin/">USBtin</a>. It may not be fast enough and may lose messages. Usually it is started with (-s5=250kbps): </p><pre class="fragment">sudo slcand -f -o -c -s5 /dev/ttyACM0 can0
sudo ip link set up can0
</pre> <h3><a class="anchor" id="autotoc_md6"></a>
CAN capes for Raspberry PI or similar</h3>
<p>RPI may work wit some of the USB CAN interfaces or with CAN shield like <a href="https://www.sg-electronic-systems.com/ecommerce/12-can-bus-shield">this</a>. CAN shield may not be fast enough and may lose messages.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
CAN utilities</h2>
<p><a href="https://github.com/linux-can/can-utils">SocketCAN userspace utilities and tools</a> contains several useful command line tools for CAN in Linux. Install with: </p><pre class="fragment">sudo apt-get install can-utils
</pre><p> In own terminal run candump to display all CAN messages with timestamp: </p><pre class="fragment">candump -td -a can0
</pre><h2><a class="anchor" id="autotoc_md8"></a>
Running CANopenLinux device</h2>
<p>Compile: </p><pre class="fragment">cd CANopenLinux
make
</pre><p> Install (copy <code>canopend</code> application to the <code>/usr/bin/</code> directory): </p><pre class="fragment">sudo make install
</pre><p> Display options: </p><pre class="fragment">canopend --help
</pre><p> Run on can0 device with CANopen NodeID = 4: </p><pre class="fragment">canopend can0 -i 4
</pre><p> If NodeID is not specified, then CANopen LSS protocol may be used. Program can be finished by pressing Ctrl+c or with CANopen reset node command.</p>
<p>After connecting the CANopen Linux device into the CAN(open) network, bootup message is visible. By default device uses Object Dictionary from <code>CANopenNode/example</code>, which contains only communication parameters. With the external CANopen tool all parameters can be accessed and CANopen Linux device can be configured (For example write heartbeat producer time in object 0x1017,0).</p>
<p>When CANopen Linux device is first connected to the CANopen network it shows bootup message and emergency message, because of missing storage files. To avoid emergency message it is necessary to trigger saveAll command (write correct code into parameter 0x1010,1 with SDO command) and restart the program.</p>
<p>Note also, if there are multiple instances of canopend running from the same directory, storage path should be specified for each.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
CANopen ASCII command interface</h2>
<p>CANopenNode includes CANopen ASCII command interface (gateway) specified by standard CiA309-3. It can be used as a commander for other CANopen devices: NMT master, LSS master, SDO client, etc. In CANopen Linux device command interface is available by default.</p>
<p>To use ASCII command interface on canopend directly just run it with <code>-c "stdio"</code> and type the commands followed by enter in it. </p><pre class="fragment">canopend can0 -i 1 -c "stdio"
help
1 write 0x1010 1 vs save
1 reset node
</pre><p> To create CANopen Linux commander device on local socket run: </p><pre class="fragment">canopend can0 -i 1 -c "local-/tmp/CO_command_socket"
</pre> <h3><a class="anchor" id="autotoc_md10"></a>
cocomm</h3>
<p>CANopenLinux/cocomm directory contains a small command line program, which establishes socket connection with <code>canopend</code> (CANopen Linux commander device). It sends standardized CANopen commands (CiA309-3) to gateway and prints the responses to stdout and stderr. See <a class="el" href="md_cocomm_README.html">cocomm/README.md</a> for usage.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Accessing ASCII command interface with Python</h3>
<p>Here is an example of simplified Python program, which works similar as <code>cocomm</code> described above (<code>canoped</code> serves on local socket). Run the program and type <code>1 r 0x1018 0 u16</code> for example.</p>
<div class="fragment"><div class="line">import socket, os</div>
<div class="line"> </div>
<div class="line">if os.path.exists(&quot;/tmp/CO_command_socket&quot;):</div>
<div class="line">    client = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)</div>
<div class="line">    client.connect(&quot;/tmp/CO_command_socket&quot;)</div>
<div class="line">    while True:</div>
<div class="line">        x = &quot;[1] &quot; + input(&quot;&gt; &quot;) + &quot;\r\n&quot;</div>
<div class="line">        if &quot;&quot; != x:</div>
<div class="line">            print(&quot;SEND:&quot;, x.encode(&quot;utf-8&quot;))</div>
<div class="line">            client.send(x.encode(&quot;utf-8&quot;))</div>
<div class="line">            print(&quot;RECEIVE:&quot;, client.recv(1024))</div>
<div class="line">    client.close()</div>
<div class="line">else:</div>
<div class="line">    print(&quot;Couldn&#39;t Connect!&quot;)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Creating new project</h1>
<p><code>canopend</code> is a basic CANopen Linux device with optional commander functionalities. However, CANopen device is able to be much more, like (simple) input/output (digital or analog) device according to standard CiA401 or anything else as specified by other CANopen device profiles or own idea.</p>
<p>New project can be started in new directory simply by adding customized makefile, custom Object Dictionary OD.h/c files and custom application source files in Arduino style, which are called from CO_main_basic.c file.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Single or multi threaded application</h2>
<p>By default canopend runs in single thread (CO_SINGLE_THREAD option in Makefile). Different events, such as can reception or timer expiration trigger looping through the stack (all code is non-blocking). It requires less system resources.</p>
<p>In multi threaded operation a real-time thread is established besides mainline thread. RT thread runs each millisecond and processes PDOs and optional application code with peripheral read/write, control program or similar. With this configuration race conditions must be taken into account, for example application code running from mainline thread must use CO_(UN)LOCK_OD macros when accessing OD variables.</p>
<p>See also <a href="https://github.com/CANopenNode/CANopenDemo">CANopenDemo</a> for examples.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Create new project with KDevelop</h2>
<ul>
<li><a href="https://www.kdevelop.org/">https://www.kdevelop.org/</a></li>
<li><code>sudo apt install kdevelop breeze</code></li>
<li>Run KDevelop, select: Project -&gt; open project</li>
<li>Navigate to project directory and click open.</li>
<li>KDevelop will recognize <code>Makefile</code> and will just use it. Click Finish.</li>
<li>Open project settings (right click on project on left panel)<ul>
<li>Make: set to 1 thread operation.</li>
<li>Language support, Includes, add paths to directories:<ul>
<li><code>&lt;path_to_CANopenLinux_driver_files&gt;</code></li>
<li><code>&lt;path_to_CANopenNode&gt;</code></li>
<li><code>&lt;path_to_project_files&gt;</code></li>
</ul>
</li>
<li>Language support, Defines, add:<ul>
<li><code>CO_DRIVER_CUSTOM</code></li>
</ul>
</li>
</ul>
</li>
<li>Run -&gt; Setup launches -&gt; <code>our_program</code>:<ul>
<li>Add Executable file and name it.</li>
<li>Executable file: <code>&lt;select_executable&gt;</code></li>
<li>Arguments: <code>can0 -i 4</code></li>
</ul>
</li>
<li>Build, then Execute or Debug</li>
</ul>
<h1><a class="anchor" id="autotoc_md15"></a>
Change Log</h1>
<ul>
<li><b><a href="https://github.com/CANopenNode/CANopenLinux/tree/HEAD">v4.0</a> - current</b>: Git repository started on GitHub.<ul>
<li>Linux driver files copied from <a href="https://github.com/CANopenNode/CANopenNode/tree/76b43c88ef6d5490cb2f1518e10646e8dcb45c76/socketCAN">https://github.com/CANopenNode/CANopenNode/tree/76b43c88ef6d5490cb2f1518e10646e8dcb45c76/socketCAN</a></li>
<li>cocomm copied from <a href="https://github.com/CANopenNode/CANopenSocket/tree/71f21e41fd4527718d8b6161938b479386d2d03b/cocomm">https://github.com/CANopenNode/CANopenSocket/tree/71f21e41fd4527718d8b6161938b479386d2d03b/cocomm</a></li>
<li>Submodule CANopenNode added.</li>
<li>Few adjustments and documentation written.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md16"></a>
License</h1>
<p>This file is part of CANopenNode, an opensource CANopen Stack. Project home page is <a href="https://github.com/CANopenNode/CANopenNode">https://github.com/CANopenNode/CANopenNode</a>. For more information on CANopen see <a href="http://www.can-cia.org/">http://www.can-cia.org/</a>.</p>
<p>Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
