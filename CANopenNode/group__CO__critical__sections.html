<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CANopenNode: Critical sections</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="CANopenNode.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CANopenNode
   </div>
   <div id="projectbrief">CANopen protocol stack</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a>  </div>
  <div class="headertitle">
<div class="title">Critical sections<div class="ingroups"><a class="el" href="group__CO__CANopen__301.html">CANopen_301</a> &raquo; <a class="el" href="group__CO__driver.html">Driver</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Protection of critical sections in multi-threaded operation.  
<a href="#details">More...</a></p>
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for Critical sections:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><iframe scrolling="no" frameborder="0" src="group__CO__critical__sections.svg" width="248" height="36"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga908c5d3fe5d6f79db4c6d72212f1f020"><td class="memItemLeft" align="right" valign="top"><a id="ga908c5d3fe5d6f79db4c6d72212f1f020"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga908c5d3fe5d6f79db4c6d72212f1f020">CO_LOCK_CAN_SEND</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:ga908c5d3fe5d6f79db4c6d72212f1f020"><td class="mdescLeft">&#160;</td><td class="mdescRight">Lock critical section in <a class="el" href="group__CO__driver.html#ga4664a9f5d547cb0605a9e929fb079f2e" title="Send CAN message.">CO_CANsend()</a> <br /></td></tr>
<tr class="separator:ga908c5d3fe5d6f79db4c6d72212f1f020"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5758ee7be17d758e3b55e3c9184d3873"><td class="memItemLeft" align="right" valign="top"><a id="ga5758ee7be17d758e3b55e3c9184d3873"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga5758ee7be17d758e3b55e3c9184d3873">CO_UNLOCK_CAN_SEND</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:ga5758ee7be17d758e3b55e3c9184d3873"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unlock critical section in <a class="el" href="group__CO__driver.html#ga4664a9f5d547cb0605a9e929fb079f2e" title="Send CAN message.">CO_CANsend()</a> <br /></td></tr>
<tr class="separator:ga5758ee7be17d758e3b55e3c9184d3873"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1bfd1de6faa39a23b04ecd1fd5db7dbd"><td class="memItemLeft" align="right" valign="top"><a id="ga1bfd1de6faa39a23b04ecd1fd5db7dbd"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga1bfd1de6faa39a23b04ecd1fd5db7dbd">CO_LOCK_EMCY</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:ga1bfd1de6faa39a23b04ecd1fd5db7dbd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Lock critical section in <a class="el" href="group__CO__Emergency.html#gab66d4a6daa5f7492704b56a46b135f71" title="Report error condition, for description of parameters see CO_error.">CO_errorReport()</a> or <a class="el" href="group__CO__Emergency.html#ga24e2a9311cf704ec6ed43b0ea730c4a3" title="Reset error condition, for description of parameters see CO_error.">CO_errorReset()</a> <br /></td></tr>
<tr class="separator:ga1bfd1de6faa39a23b04ecd1fd5db7dbd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1d7a22feece8448f985a608f83ea67a6"><td class="memItemLeft" align="right" valign="top"><a id="ga1d7a22feece8448f985a608f83ea67a6"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga1d7a22feece8448f985a608f83ea67a6">CO_UNLOCK_EMCY</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:ga1d7a22feece8448f985a608f83ea67a6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unlock critical section in <a class="el" href="group__CO__Emergency.html#gab66d4a6daa5f7492704b56a46b135f71" title="Report error condition, for description of parameters see CO_error.">CO_errorReport()</a> or <a class="el" href="group__CO__Emergency.html#ga24e2a9311cf704ec6ed43b0ea730c4a3" title="Reset error condition, for description of parameters see CO_error.">CO_errorReset()</a> <br /></td></tr>
<tr class="separator:ga1d7a22feece8448f985a608f83ea67a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae91e416633b4df1800e97a2bc02bbeb4"><td class="memItemLeft" align="right" valign="top"><a id="gae91e416633b4df1800e97a2bc02bbeb4"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#gae91e416633b4df1800e97a2bc02bbeb4">CO_LOCK_OD</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:gae91e416633b4df1800e97a2bc02bbeb4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Lock critical section when accessing Object Dictionary. <br /></td></tr>
<tr class="separator:gae91e416633b4df1800e97a2bc02bbeb4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga37d2c1496e5304faf5f0670ef33a4704"><td class="memItemLeft" align="right" valign="top"><a id="ga37d2c1496e5304faf5f0670ef33a4704"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga37d2c1496e5304faf5f0670ef33a4704">CO_UNLOCK_OD</a>(CAN_MODULE)</td></tr>
<tr class="memdesc:ga37d2c1496e5304faf5f0670ef33a4704"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unock critical section when accessing Object Dictionary. <br /></td></tr>
<tr class="separator:ga37d2c1496e5304faf5f0670ef33a4704"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga577a6ebcf246087f084c75d9ae25eeb7"><td class="memItemLeft" align="right" valign="top"><a id="ga577a6ebcf246087f084c75d9ae25eeb7"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga577a6ebcf246087f084c75d9ae25eeb7">CO_FLAG_READ</a>(rxNew)&#160;&#160;&#160;((rxNew) != <a class="el" href="group__CO__dataTypes.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</td></tr>
<tr class="memdesc:ga577a6ebcf246087f084c75d9ae25eeb7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if new message has arrived. <br /></td></tr>
<tr class="separator:ga577a6ebcf246087f084c75d9ae25eeb7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac54b5e4f680aa8b0177f0df5d5be2e88"><td class="memItemLeft" align="right" valign="top"><a id="gac54b5e4f680aa8b0177f0df5d5be2e88"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#gac54b5e4f680aa8b0177f0df5d5be2e88">CO_FLAG_SET</a>(rxNew)&#160;&#160;&#160;{ __sync_synchronize(); rxNew = (void *)1L; }</td></tr>
<tr class="memdesc:gac54b5e4f680aa8b0177f0df5d5be2e88"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set new message flag. <br /></td></tr>
<tr class="separator:gac54b5e4f680aa8b0177f0df5d5be2e88"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga044da4253aeed15c3e0bb7fce13664af"><td class="memItemLeft" align="right" valign="top"><a id="ga044da4253aeed15c3e0bb7fce13664af"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__CO__critical__sections.html#ga044da4253aeed15c3e0bb7fce13664af">CO_FLAG_CLEAR</a>(rxNew)&#160;&#160;&#160;{ __sync_synchronize(); rxNew = <a class="el" href="group__CO__dataTypes.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; }</td></tr>
<tr class="memdesc:ga044da4253aeed15c3e0bb7fce13664af"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clear new message flag. <br /></td></tr>
<tr class="separator:ga044da4253aeed15c3e0bb7fce13664af"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Protection of critical sections in multi-threaded operation. </p>
<p>CANopenNode is designed to run in different threads, as described in <a href="index.html">README.md</a>. Threads are implemented differently in different systems. In microcontrollers threads are interrupts with different priorities, for example. It is necessary to protect sections, where different threads access to the same resource. In simple systems interrupts or scheduler may be temporary disabled between access to the shared resource. Otherwise mutexes or semaphores can be used.</p>
<h4><a class="anchor" id="autotoc_md99"></a>
Reentrant functions</h4>
<p>Functions <a class="el" href="group__CO__driver.html#ga4664a9f5d547cb0605a9e929fb079f2e" title="Send CAN message.">CO_CANsend()</a> from C_driver.h, and <a class="el" href="group__CO__Emergency.html#ga9221f9f631ead4b6f66cfcff8614ba46" title="Set or reset error condition.">CO_error()</a> from <a class="el" href="CO__Emergency_8h.html" title="CANopen Emergency protocol.">CO_Emergency.h</a> may be called from different threads. Critical sections must be protected. Either by disabling scheduler or interrupts or by mutexes or semaphores. Lock/unlock macro is called with pointer to CAN module, which may be used inside.</p>
<h4><a class="anchor" id="autotoc_md100"></a>
Object Dictionary variables</h4>
<p>In general, there are two threads, which accesses OD variables: mainline (initialization, storage, SDO access) and timer (PDO access). CANopenNode uses locking mechanism, where SDO server (or other mainline code) prevents execution of the real-time thread at the moment it reads or writes OD variable. <a class="el" href="group__CO__critical__sections.html#gae91e416633b4df1800e97a2bc02bbeb4" title="Lock critical section when accessing Object Dictionary.">CO_LOCK_OD(CAN_MODULE)</a> and <a class="el" href="group__CO__critical__sections.html#ga37d2c1496e5304faf5f0670ef33a4704" title="Unock critical section when accessing Object Dictionary.">CO_UNLOCK_OD(CAN_MODULE)</a> macros are used to protect:</p><ul>
<li>Whole real-time thread,</li>
<li>SDO server protects read/write access to OD variable, if specific OD variable has ODA_TRPDO or ODA_TRSRDO from <a class="el" href="group__CO__ODinterface.html#ga47b0d204aaf1ea64b4f826aaf8f5c151">OD_attributes_t</a> set. If those attributes are not set, OD variable is not locked by SDO server. Locking of long OD variables, not accessible from real-time thread, may block RT thread.</li>
<li>Any mainline code, which accesses PDO-mappable OD variable, must protect read/write with locking macros. Use <a class="el" href="group__CO__ODinterface.html#gaef29df3d19b9f99fbfc803902140fdc3">OD_mappable()</a> for check.</li>
<li>Other cases, where non-PDO-mappable OD variable is used inside real-time thread by some other part of the user application must be considered with special care.</li>
</ul>
<h4><a class="anchor" id="autotoc_md101"></a>
Synchronization functions for CAN receive</h4>
<p>After CAN message is received, it is pre-processed in <a class="el" href="group__CO__CAN__Message__reception.html#ga23168979123a5ca8a87d49307eb2990e" title="CAN receive callback function which pre-processes received CAN message.">CANrx_callback()</a>, which copies some data into appropriate object and at the end sets <b>new_message</b> flag. This flag is then pooled in another thread, which further processes the message. The problem is, that compiler optimization may shuffle memory operations, so it is necessary to ensure, that <b>new_message</b> flag is surely set at the end. It is necessary to use <a href="https://en.wikipedia.org/wiki/Memory_barrier">Memory barrier</a>.</p>
<p>If receive function runs inside IRQ, no further synchronization is needed. Otherwise, some kind of synchronization has to be included. The following example uses GCC builtin memory barrier <code>__sync_synchronize()</code>. More information can be found <a href="https://stackoverflow.com/questions/982129/what-does-sync-synchronize-do#982179">here</a>. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
